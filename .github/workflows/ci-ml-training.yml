name: CI — ML Training Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - "training/**"
      - "libs/seld-common/**"
      - ".github/workflows/ci-ml-training.yml"
  pull_request:
    paths:
      - "training/**"
      - "libs/seld-common/**"

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          cd training
          uv sync --dev

      - name: Lint with ruff
        run: |
          cd training
          uv run ruff check src/ tests/
          uv run ruff format --check src/ tests/

      - name: Type check
        run: |
          cd training
          uv run mypy src/

      - name: Run unit tests (no GPU)
        run: |
          cd training
          uv run pytest tests/ -v --tb=short -m "not gpu"

  smoke-test:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          cd training
          uv sync --dev

      - name: Smoke test — model forward pass
        run: |
          cd training
          uv run python -c "
          from seld_training.model.resnet_conformer import ResNetConformer
          import torch
          model = ResNetConformer(num_classes=13, num_tracks=3)
          x = torch.randn(1, 7, 100, 128)
          y = model(x)
          assert y.shape == (1, 25, 13, 3, 3), f'Unexpected shape: {y.shape}'
          print('Smoke test passed: output shape', y.shape)
          "

      - name: Smoke test — ONNX export
        run: |
          cd training
          uv run python -c "
          from seld_training.export.onnx_export import export_to_onnx
          from seld_training.model.resnet_conformer import ResNetConformer
          model = ResNetConformer(num_classes=13, num_tracks=3)
          export_to_onnx(model, '/tmp/test_model.onnx', opset=17)
          print('ONNX export smoke test passed')
          "
